generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum TournamentStatus {
  OPEN
  RUNNING
  CLOSED
}

enum TournamentMode {
  CLASSIC
  GAUNTLET
  KING
}

enum MatchStatus {
  SCHEDULED
  IN_PROGRESS
  CLOSED
  DB_ONLY
  CONFIRMED
  FAILED
}

enum FriendStatus {
  pending
  accepted
  blocked
}

model User {
  id                 String             @id @default(cuid())
  username           String             @unique
  email              String             @unique
  alias              String?
  passwordHash       String?
  twoFactorEnabled   Boolean            @default(false) @map("two_factor_enabled")
  avatarUrl          String?            @map("avatar_url")
  playerRef          String?            @unique @map("player_ref")
  lastSeen           DateTime?          @default(now()) @map("last_seen")
  TwoFactors         TwoFactor[]
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @default(now()) @updatedAt @map("updated_at")
  matchStats         PlayerMatchStats[]
  friendOf           Friend[]           @relation("UserFriendOf")
  friends            Friend[]           @relation("UserFriends")
  matchesWon         Match[]            @relation("Winner")
  matchesAsP2        Match[]            @relation("P2")
  matchesAsP1        Match[]            @relation("P1")
  snakeMatchesWon    SnakeMatch[]       @relation("SnakeWinner")
  snakeMatchesAsP2   SnakeMatch[]       @relation("SnakeP2")
  snakeMatchesAsP1   SnakeMatch[]       @relation("SnakeP1")
  sessions           Session[]
  createdTournaments Tournament[]       @relation("UserCreatedTournaments")
  tournaments        Tournament[]       @relation("TournamentParticipants")
  refreshTokens      RefreshToken[]
  googleId           String?            @unique
}

model Tournament {
  id              String           @id @default(cuid())
  code            String           @unique
  name            String
  status          TournamentStatus @default(OPEN)
  mode            TournamentMode   @default(CLASSIC)
  maxParticipants Int              @map("max_participants")
  kingMaxTime     Int?             @map("king_max_time")
  kingMaxRounds   Int?             @map("king_max_rounds")
  createdBy       String?          @map("created_by")
  createdAt       DateTime         @default(now()) @map("created_at")
  txHash          String?          @map("tx_hash")
  blockNumber     Int?             @map("block_number")
  onchainAt       DateTime?        @map("onchain_at")
  blockchainError String?          @map("blockchain_error")
  matches         Match[]
  creator         User?            @relation("UserCreatedTournaments", fields: [createdBy], references: [id])
  participants    User[]           @relation("TournamentParticipants")

  @@index([status])
}

model Match {
  id              String             @id @default(cuid())
  tournamentId    String?            @map("tournament_id")
  gameCode        String             @default("pong") @map("game_code")
  round           Int?
  gameIndex       Int?               @map("game_index")
  p1UserId        String?            @map("p1_user_id")
  p1Ref           String?            @map("p1_ref")
  p1Score         Int?               @map("p1_score")
  p2UserId        String?            @map("p2_user_id")
  p2Ref           String?            @map("p2_ref")
  p2Score         Int?               @map("p2_score")
  winnerUserId    String?            @map("winner_user_id")
  winnerRef       String?            @map("winner_ref")
  loserUserId     String?            @map("loser_user_id")
  status          MatchStatus        @default(SCHEDULED)
  onchainAt       DateTime?          @map("onchain_at")
  closedAt        DateTime?          @map("closed_at")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @default(now()) @updatedAt @map("updated_at")
  totalPoints     Int?               @map("total_points") // 3 | 4 | 5
  totalRallies    Int?               @map("total_rallies") // Nombre total d'échanges
  maxBounces      Int?               @map("max_bounces") // Nombre max d'échanges en une partie
  avgRallyBounces Float?             @map("avg_rally_bounces") // Moyenne des échanges par partie
  totalMatchTime  Float?             @map("total_match_time") // Temps total du match (en secondes)
  avgRallyTime    Float?             @map("avg_rally_time") // Temps moyen par partie (en secondes)
  playerStats     PlayerMatchStats[]
  winner          User?              @relation("Winner", fields: [winnerUserId], references: [id])
  p2              User?              @relation("P2", fields: [p2UserId], references: [id])
  p1              User?              @relation("P1", fields: [p1UserId], references: [id])
  tournament      Tournament?        @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, round, gameIndex])
  @@index([tournamentId])
  @@index([status])
}

model PlayerMatchStats {
  id                   String   @id @default(cuid())
  matchId              String   @map("match_id")
  userId               String?  @map("user_id")
  score                Int      @default(0)
  maxWins              Int      @default(0) @map("max_wins")
  totalBallSpins       Int      @default(0) @map("total_ball_spins")
  maxBouncesInWonRally Int      @default(0) @map("max_bounces_in_won_rally")
  maxEffectsInWonRally Int      @default(0) @map("max_effects_in_won_rally")
  maxBallSpeedWon      Float    @default(0) @map("max_ball_speed_won")
  maxBallSpeedLost     Float    @default(0) @map("max_ball_speed_lost")
  fastestWonRally      Float    @default(0) @map("fastest_won_rally") // en secondes
  fastestLostRally     Float    @default(0) @map("fastest_lost_rally") // en secondes
  createdAt            DateTime @default(now()) @map("created_at")
  match                Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user                 User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([matchId, userId]) // Un joueur = 1 ligne de stats par match
  @@index([userId])
  @@index([matchId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Friend {
  userId    String       @map("user_id")
  friendId  String       @map("friend_id")
  status    FriendStatus @default(pending)
  createdAt DateTime     @default(now()) @map("created_at")
  friend    User         @relation("UserFriendOf", fields: [friendId], references: [id], onDelete: Cascade)
  user      User         @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, friendId])
}

model TwoFactor {
  id        Int      @id @default(autoincrement())
  userId    String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model SnakeMatch {
  id             String    @id @default(cuid())
  gameCode       String    @default("snake") @map("game_code")
  p1UserId       String?   @map("p1_user_id")
  p1Score        Int       @map("p1_score")
  p1Collectibles Int       @map("p1_collectibles")
  p2UserId       String?   @map("p2_user_id")
  p2Score        Int       @map("p2_score")
  p2Collectibles Int       @map("p2_collectibles")
  winnerUserId   String?   @map("winner_user_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at")
  winner         User?     @relation("SnakeWinner", fields: [winnerUserId], references: [id])
  p2             User?     @relation("SnakeP2", fields: [p2UserId], references: [id])
  p1             User?     @relation("SnakeP1", fields: [p1UserId], references: [id])

  @@index([p1UserId])
  @@index([p2UserId])
  @@index([winnerUserId])
}
